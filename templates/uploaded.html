<!DOCTYPE html>
<html>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<head>
    <title>Uploaded Image</title>
</head>
<body>
<div id="all">
    <div class="up-menu">
        <button class="icon-btn" id="lasso"></button>
        <button class="icon-btn" id="pencil"></button>
        <button class="icon-btn" id="text-btn"></button>
    </div>
    <div id="menu-and-picture">
        <div class="translation-menu">
            <div>
                <select class="select1" name="models" id="model-select">
                    <option value="google_translate">Google переводчик</option>
                    <option value="test1">тест1</option>
                    <option value="test2">тест2</option>
                </select>
            </div>
            <div>
                <select class="select1" name="languages" id="start-language-select">
                    <option value="English">English</option>
                    <option value="Japanese">Japanese</option>
                    <option value="Russian">Russian</option>
                </select>
            </div>
            <div><textarea readonly="readonly"></textarea></div>
            <div>
                <select class="select1" name="languages2" id="end-language-select">
                    <option value="English">English</option>
                    <option value="Japanese">Japanese</option>
                    <option value="Russian">Russian</option>
                </select>
            </div>
            <div><textarea readonly="readonly"></textarea></div>
            <div>
                <button class="button">Перевести</button>
            </div>
        </div>
        <div id="picture-download" style="position: relative;">
            <img src="{{ url_for('send_uploaded_file', filename=filename) }}" alt="Uploaded Image" id="original-image">
            <button class="button"><a href="{{ url_for('send_uploaded_file', filename=filename) }}">Загрузить</a></button>
            <div id="bubble-overlays" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></div>
        </div>
        <div class="text-menu">
            <div>
                <select name="fonts" id="fonts-select" class="select2">
                    <option value="Times New Roman">English</option>
                    <option value="Arial">Japanese</option>
                    <option value="Comic Sans">Russian</option>
                </select>
            </div>
            <div>
                <select name="types" id="types-select" class="select2">
                    <option value="Regular">English</option>
                    <option value="Bold">Japanese</option>
                    <option value="Thick">Russian</option>
                </select>
            </div>
            <div>
                <select name="fontsize" id="fontsize-select" class="select2">
                    <option value="10">10</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="22">22</option>
                    <option value="24">24</option>
                </select>
            </div>
            <div>тут будет выбор выравнивания</div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const bubbles = {{ bubbles|tojson }};
        const originalImage = document.getElementById('original-image');
        const overlaysContainer = document.getElementById('bubble-overlays');

        originalImage.onload = function () {
            const imageRect = originalImage.getBoundingClientRect();
            const containerRect = overlaysContainer.getBoundingClientRect();
            const naturalWidth = originalImage.naturalWidth;
            const naturalHeight = originalImage.naturalHeight;

            const scaleX = imageRect.width / naturalWidth;
            const scaleY = imageRect.height / naturalHeight;

            bubbles.forEach((bubble, index) => {
                const bubbleDiv = document.createElement('div');
                bubbleDiv.id = `bubble-${index}`;
                bubbleDiv.style.position = 'absolute';
                bubbleDiv.style.pointerEvents = 'none';

                const bubbleInfo = document.createElement('div');
                bubbleInfo.style.display = 'none';
                bubbleInfo.innerHTML = `Description: ${bubble[1]}<br>Locale: ${bubble[2]}`;
                bubbleDiv.appendChild(bubbleInfo);

                bubble[0].forEach((fill, fillIndex) => {
                    const fillImg = document.createElement('img');
                    fillImg.src = '/temp/' + fill[2];
                    fillImg.style.position = 'absolute';
                    fillImg.style.left = `${(fill[0][0] * scaleX) + (imageRect.left - containerRect.left)}px`;
                    fillImg.style.top = `${(fill[0][1] * scaleY) + (imageRect.top - containerRect.top)}px`;
                    fillImg.style.width = `${(fill[1][0] - fill[0][0]) * scaleX}px`;
                    fillImg.style.height = `${(fill[1][1] - fill[0][1]) * scaleY}px`;
                    bubbleDiv.appendChild(fillImg);
                });

                overlaysContainer.appendChild(bubbleDiv);
            });
        };

        if (originalImage.complete) {
            originalImage.onload();
        }
    });
</script>

<style>
    #all {
        position: relative;
    }

    #bubble-overlays img {
        max-width: none; /* Prevent images from resizing based on container */
    }

    #original-image {
        display: block;
        max-width: 100%;
        z-index: 5;
    }
</style>
</body>
</html>
